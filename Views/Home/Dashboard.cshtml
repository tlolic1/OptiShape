@using Microsoft.AspNetCore.Identity
@using OptiShape.Models
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject OptiShape.Data.ApplicationDbContext DbContext

@{
    ViewData["Title"] = "Dashboard";
    ViewData["FixedNavbar"] = true;

    var appUser = await UserManager.GetUserAsync(User);
    var isAdmin = User.IsInRole("Administrator");
    var isTrainer = User.IsInRole("Trener");

    Korisnik korisnik = null;
    Korisnik trener = null;
    List<Korisnik> klijenti = new List<Korisnik>();
    bool showStudentApplication = false;
    bool showTrainerSelection = false;
    bool hasRecentPayment = false;
    DateTime lastMonth = DateTime.Now.AddMonths(-1);
    int godine = 0;

    if (appUser != null && !isAdmin && !isTrainer)
    {
        korisnik = await DbContext.Korisnik.FirstOrDefaultAsync(k => k.Email == appUser.Email);

        if (korisnik != null)
        {
            showStudentApplication = !korisnik.StudentskiStatus;
            showTrainerSelection = korisnik.IdTrenera == null;

            // godina
            godine = DateTime.Now.Year - korisnik.DatumRodjenja.Year;
            if (korisnik.DatumRodjenja > DateTime.Now.AddYears(-godine)) godine--;

            // trener
            if (korisnik.IdTrenera != null)
                trener = await DbContext.Korisnik.FirstOrDefaultAsync(t => t.IdKorisnika == korisnik.IdTrenera);

            hasRecentPayment = await DbContext.Placanje
                .AnyAsync(p => p.IdKorisnika == korisnik.IdKorisnika && p.DatumPlacanja >= lastMonth);
        }
    }
    else if (appUser != null && isTrainer)
    {
        // Ako je korisnik trener, dohvati njegove podatke
        korisnik = await DbContext.Korisnik.FirstOrDefaultAsync(k => k.Email == appUser.Email);

        if (korisnik != null)
        {
            // Dohvati sve klijente ovog trenera
            klijenti = await DbContext.Korisnik
                .Where(k => k.IdTrenera == korisnik.IdKorisnika)
                .ToListAsync();

            // godina
            godine = DateTime.Now.Year - korisnik.DatumRodjenja.Year;
            if (korisnik.DatumRodjenja > DateTime.Now.AddYears(-godine)) godine--;
        }
    }
}

<!-- Add simplified CSS styles -->
<style>
    /* Simple fade-in animation */
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    /* Modern card styles with solid colors */
    .modern-card {
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        animation: fadeIn 0.5s ease-out forwards;
        border: none;
        margin-bottom: 1.5rem;
    }

        .modern-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

    .card-header-solid {
        background-color: #4a6bdf;
        color: white;
        border-bottom: none;
        padding: 15px 20px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .card-header-primary {
        background-color: #4a6bdf;
    }

    .card-header-success {
        background-color: #28a745;
    }

    .card-header-warning {
        background-color: #fd7e14;
    }

    .card-header-info {
        background-color: #17a2b8;
    }

    .card-header-secondary {
        background-color: #6c757d;
    }

    .welcome-text {
        font-size: 2rem;
        font-weight: 700;
        color: #4a6bdf;
        margin-bottom: 0.5rem;
        animation: fadeIn 0.5s ease-out forwards;
    }

    .welcome-subtitle {
        font-size: 1.1rem;
        color: #6c757d;
        margin-bottom: 1.5rem;
        animation: fadeIn 0.7s ease-out forwards;
    }

    .btn-modern {
        border-radius: 6px;
        padding: 8px 16px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
    }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

    .btn-modern-primary {
        background-color: #4a6bdf;
        color: white;
    }

    .btn-modern-success {
        background-color: #28a745;
        color: white;
    }

    .btn-modern-warning {
        background-color: #fd7e14;
        color: white;
    }

    .emoji-icon {
        margin-right: 0.5rem;
    }

    .price-display {
        font-size: 1.8rem;
        font-weight: 600;
        text-align: center;
        margin: 1rem 0;
    }

        .price-display.student {
            color: #4a6bdf;
        }

        .price-display.regular {
            color: #fd7e14;
        }

    .alert-modern {
        border-radius: 8px;
        padding: 12px 16px;
        border: none;
    }

    .alert-modern-success {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
    }

    .alert-modern-danger {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
    }

    .profile-item {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .profile-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #4a6bdf;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-right: 12px;
    }

    .delay-1 {
        animation-delay: 0.1s;
    }

    .delay-2 {
        animation-delay: 0.2s;
    }

    .delay-3 {
        animation-delay: 0.3s;
    }

    /* Added style for welcome section with increased spacing */
    .welcome-section {
        margin-bottom: 3rem; /* Increased spacing */
    }

    /* Client list styles */
    .client-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .client-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        transition: all 0.2s ease;
    }

        .client-item:last-child {
            border-bottom: none;
        }

        .client-item:hover {
            background-color: #f8f9fa;
        }

    .client-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        color: #6c757d;
        font-weight: bold;
        flex-shrink: 0;
    }

    .client-info {
        flex-grow: 1;
    }

    .client-name {
        font-weight: 600;
        margin-bottom: 2px;
    }

    .client-detail {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .client-badge {
        margin-left: 8px;
    }

    .empty-list {
        padding: 20px;
        text-align: center;
        color: #6c757d;
    }
</style>

<div class="container py-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Added welcome-section class for increased spacing -->
            <div class="welcome-section">
                <h1 class="welcome-text">👋 Pozdrav, @(korisnik != null ? korisnik.Ime : appUser?.Ime ?? User.Identity?.Name)!</h1>
                <p class="welcome-subtitle">Dobrodošli na vašu OptiShape kontrolnu tablu</p>
            </div>

            @if (isTrainer && korisnik != null)
            {
                <div class="modern-card delay-1">
                    <div class="card-header-solid card-header-success">
                        <i class="bi bi-people-fill me-2"></i>
                        Moji klijenti
                    </div>
                    <div class="card-body p-0">
                        @if (klijenti.Any())
                        {
                            <ul class="client-list">
                                @foreach (var klijent in klijenti)
                                {
                                    <li class="client-item">
                                        <div class="client-avatar">
                                            @klijent.Ime[0]@klijent.Prezime[0]
                                        </div>
                                        <div class="client-info">
                                            <div class="client-name">@klijent.Ime @klijent.Prezime</div>
                                            <div class="client-detail">
                                                <i class="bi bi-envelope-fill me-1"></i> @klijent.Email
                                                @if (klijent.BrojTelefona != null)
                                                {
                                                    <span class="ms-2"><i class="bi bi-telephone-fill me-1"></i> @klijent.BrojTelefona</span>
                                                }
                                            </div>
                                        </div>
                                        @if (klijent.StudentskiStatus)
                                        {
                                            <span class="badge bg-primary client-badge">Student</span>
                                        }
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <div class="empty-list">
                                
                                <p>Trenutno nemate klijenata.</p>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (showStudentApplication)
            {
                <div class="modern-card delay-1">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3">
                            <span class="emoji-icon">🎓</span>
                            Student ste?
                        </h5>
                        <p class="card-text">
                            Kao student imate pravo na posebne pogodnosti i popuste. Aplicirajte za studentski račun.
                        </p>
                        <a asp-controller="Home" asp-action="StudentApplication" class="btn btn-modern btn-modern-primary mt-2">
                            <i class="bi bi-mortarboard-fill me-2"></i>
                            Apliciraj za studentski račun
                        </a>
                    </div>
                </div>
            }

            @if (showTrainerSelection)
            {
                <div class="modern-card delay-2">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3">
                            <span class="emoji-icon">💪</span>
                            Nemate trenera?
                        </h5>
                        <p class="card-text">
                            Odaberite svog personalnog trenera i započnite program treninga i ishrane.
                        </p>
                        <a asp-controller="Home" asp-action="IzborTrenera" class="btn btn-modern btn-modern-success mt-2">
                            <i class="bi bi-person-check-fill me-2"></i>
                            Izaberi trenera
                        </a>
                    </div>
                </div>
            }

            @if (korisnik != null && !isTrainer)
            {
                <div class="modern-card delay-3">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3">
                            <span class="emoji-icon">💳</span>
                            Vaša mjesečna tarifa
                        </h5>
                        <p class="card-text text-center">
                            Kao @(korisnik.StudentskiStatus ? "student" : "korisnik"), vaša mjesečna tarifa je:
                        </p>

                        <div class="price-display @(korisnik.StudentskiStatus ? "student" : "regular")">
                            <strong>@(korisnik.StudentskiStatus ? "7 KM" : "10 KM")</strong>
                            <small class="text-muted">/mjesečno</small>
                        </div>

                        <div class="text-center mb-3">
                            @if (korisnik.StudentskiStatus)
                            {
                                <span class="badge bg-primary px-2 py-1">
                                    <i class="bi bi-check-circle-fill me-1"></i>
                                    Studentski popust primijenjen!
                                </span>
                            }
                            else
                            {
                                <small class="text-muted">Aplicirajte za studentski status za popust.</small>
                            }
                        </div>

                        <div class="alert alert-modern @(hasRecentPayment ? "alert-modern-success" : "alert-modern-danger") text-center mt-3">
                            @if (hasRecentPayment)
                            {
                                <div>
                                    <span class="emoji-icon">✅</span>
                                    <strong>Platili ste članarinu za ovaj mjesec.</strong>
                                </div>
                            }
                            else
                            {
                                <div>
                                    <span class="emoji-icon">⚠️</span>
                                    <strong>Niste platili članarinu za ovaj mjesec.</strong>
                                </div>
                            }
                        </div>

                        @if (!hasRecentPayment)
                        {
                            <div class="text-center mt-3">
                                <a asp-controller="Placanje" asp-action="CreateForUser" class="btn btn-modern btn-modern-warning">
                                    <i class="bi bi-cash-coin me-2"></i>
                                    Izvrši plaćanje članarine
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        @if (korisnik != null)
        {
            <div class="col-md-4">
                <div class="modern-card delay-1">
                    <div class="card-header-solid card-header-info">
                        <i class="bi bi-person-circle me-2"></i>
                        Vaši podaci
                    </div>
                    <div class="card-body p-4">
                        <div class="profile-item">
                            <i class="bi bi-rulers me-2 text-secondary"></i>
                            <div>
                                <strong>Visina:</strong> @korisnik.Visina cm
                            </div>
                        </div>

                        <div class="profile-item">
                            <i class="bi bi-telephone me-2 text-secondary"></i>
                            <div>
                                <strong>Telefon:</strong> @(korisnik.BrojTelefona ?? "Nije unesen")
                            </div>
                        </div>

                        <div class="profile-item">
                            <i class="bi bi-calendar3 me-2 text-secondary"></i>
                            <div>
                                <strong>Godine:</strong> @godine
                            </div>
                        </div>

                        <div class="profile-item">
                            <i class="bi bi-award me-2 text-secondary"></i>
                            <div>
                                <strong>Status:</strong>
                                @if (isTrainer)
                                {
                                    <span class="badge bg-success ms-2">Trener</span>
                                }
                                else if (!hasRecentPayment)
                                {
                                    <span class="badge bg-danger ms-2">Nije plaćeno</span>
                                }
                                else if (korisnik.StudentskiStatus)
                                {
                                    <span class="badge bg-primary ms-2">Student</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning ms-2">Korisnik</span>
                                }
                            </div>
                        </div>

                        <hr class="my-3" />

                        <div class="text-center">
                            @if (!isTrainer)
                            {
                                <a asp-controller="StatistikeNapretka" asp-action="Index" class="btn btn-modern btn-modern-primary w-100">
                                    <i class="bi bi-graph-up me-2"></i>
                                    Pogledaj napredak
                                </a>
                            }
                        </div>
                    </div>
                </div>

                @if (trener != null && !isTrainer)
                {
                    <div class="modern-card delay-2">
                        <div class="card-header-solid card-header-secondary">
                            <i class="bi bi-person-bounding-box me-2"></i>
                            Moj trener
                        </div>
                        <div class="card-body p-4">
                            <div class="text-center mb-3">
                                <div style="width: 80px; height: 80px; background-color: #6c757d; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                                    <i class="bi bi-person"></i>
                                </div>
                                <h5 class="mt-3 mb-0">@trener.Ime @trener.Prezime</h5>
                                <p class="text-muted">Personalni trener</p>
                            </div>

                            <div class="profile-item">
                                <i class="bi bi-envelope me-2 text-secondary"></i>
                                <div>
                                    <strong>Email:</strong> @trener.Email
                                </div>
                            </div>

                            <div class="profile-item">
                                <i class="bi bi-telephone me-2 text-secondary"></i>
                                <div>
                                    <strong>Telefon:</strong> @(trener.BrojTelefona ?? "Nije unesen")
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (isTrainer)
                {
                    <div class="modern-card delay-2">
                        <div class="card-header-solid card-header-warning">
                            <i class="bi bi-bar-chart-fill me-2"></i>
                            Statistika
                        </div>
                        <div class="card-body p-4">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <div style="font-size: 2rem; font-weight: 700; color: black ;">
                                        @klijenti.Count
                                    </div>
                                    <div class="text-muted">Klijenti</div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div style="font-size: 2rem; font-weight: 700; color: #4a6bdf;">
                                        @klijenti.Count(k => k.StudentskiStatus)
                                    </div>
                                    <div class="text-muted">Studenti</div>
                                </div>
                            </div>

                            <hr class="my-3" />

                            <div class="text-center">
                                <a asp-controller="Termin" asp-action="Index" class="btn btn-modern btn-modern-warning w-100">
                                    <i class="bi bi-calendar-week me-2"></i>
                                    Raspored treninga
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- Add simplified JavaScript for animations -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Simple animation on load
        const animatedElements = document.querySelectorAll('.modern-card');
        animatedElements.forEach(element => {
            element.style.opacity = '0';
            setTimeout(() => {
                element.style.opacity = '1';
            }, 100);
        });
    });
</script>